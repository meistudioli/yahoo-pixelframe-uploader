import{_wcl}from"./common-lib.js";import{_wccss}from"./common-css.js";import"./aws-sdk-2.633.0.min.js";const defaults={multiple:!1,accept:".jpg,.jpeg,.png,.gif,.webp,.avif,.mov,.mp4,.ogg,.webm",imagelimitation:{minwidth:100,minheight:100,size:52428800},videolimitation:{minwidth:100,minheight:100,size:314572800,duration:3600},maximagecount:5,maxvideocount:5,webservice:{token:{url:"https://trendr-apac.media.yahoo.com/api/pixelframe/v1/aws/resources/s3/credentials?role=content-upload"},upload:{urls:{video:"https://trendr-apac.media.yahoo.com/api/pixelframe/v1/videos/upload",image:"https://trendr-apac.media.yahoo.com/api/pixelframe/v1/images/upload"},params:{targetType:"rating",targetId:"auction2",appName:"auction",resizingProfile:"bid_seller_logo",transcodingProfile:"auction"}}}},booleanAttrs=["multiple"],objectAttrs=["imagelimitation","videolimitation","webservice"],custumEvents={pick:"yahoo-pixelframe-uploader-pick",error:"yahoo-pixelframe-uploader-error",processStart:"yahoo-pixelframe-uploader-process-start",processEnd:"yahoo-pixelframe-uploader-process-end",progress:"yahoo-pixelframe-uploader-progress",done:"yahoo-pixelframe-uploader-done"},isMobile=!window.matchMedia("(hover: hover)").matches,template=document.createElement("template");template.innerHTML=`
<style>
${_wccss}

:host{position:relative;display:block;}

.main {
  inline-size: fit-content;
  block-size: fit-content;

  .uploader-trigger {
    position: relative;
    inline-size: fit-content;
    block-size: fit-content;
    overflow: hidden;
    display: block;

    &>input[type="file"] {
      position: absolute;
      inset-block-start: -100%;
    }
  }
}
</style>

<div class="main" ontouchstart="">
  <label class="uploader-trigger">
    <input class="uploader-trigger__input" type="file" />
    <slot name="trigger"></slot>
  </label>
</div>
`;class YahooPixelframeUploader extends HTMLElement{#data;#nodes;#config;constructor(e){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(template.content.cloneNode(!0)),this.#data={controller:"",units:{},order:[],processing:!1},this.#nodes={styleSheet:this.shadowRoot.querySelector("style"),input:this.shadowRoot.querySelector(".uploader-trigger__input")},this.#config={...defaults,...e},this._onFilesChange=this._onFilesChange.bind(this)}async connectedCallback(){var{config:e,error:t}=await _wcl.getWCConfig(this),i=this.#nodes["input"];t?(console.warn(_wcl.classToTagName(this.constructor.name)+": "+t),this.remove()):(this.#config={...this.#config,...e},Object.keys(defaults).forEach(e=>this.#upgradeProperty(e)),this.#data.controller=new AbortController,t=this.#data.controller.signal,i.addEventListener("change",this._onFilesChange,{signal:t}))}disconnectedCallback(){this.#data?.controller&&this.#data.controller.abort()}#format(i,e,s){if(null!==s)switch(i){case"webservice":{let t;try{t=JSON.parse(s)}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),t=Array.isArray(defaults[i])?[...defaults[i]]:{...defaults[i]}}this.#config[i]=t;break}case"imagelimitation":case"videolimitation":{let t;try{t=JSON.parse(s)}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),t=Array.isArray(defaults[i])?[...defaults[i]]:{...defaults[i]}}this.#config[i]={...defaults[i],...t};break}case"maximagecount":case"maxvideocount":var t=+s;this.#config[i]=isNaN(t)||t<0?defaults[i]:t;break;case"accept":this.#config[i]=0<s.length?s:defaults[i]}else booleanAttrs.includes(i)?this.#config[i]=!1:this.#config[i]=defaults[i]}attributeChangedCallback(e,t,i){if(YahooPixelframeUploader.observedAttributes.includes(e)){var s=this.#nodes["input"];switch(this.#format(e,t,i),e){case"multiple":s.toggleAttribute("multiple",this.multiple);break;case"accept":s.setAttribute("accept",this.accept)}}}static get observedAttributes(){return Object.keys(defaults)}static get supportedEvents(){return Object.keys(custumEvents).map(e=>custumEvents[e])}#upgradeProperty(e){let t;YahooPixelframeUploader.observedAttributes.includes(e)&&(Object.prototype.hasOwnProperty.call(this,e)?(t=this[e],delete this[e]):t=booleanAttrs.includes(e)?!(!this.hasAttribute(e)&&!this.#config[e]):objectAttrs.includes(e)?this.hasAttribute(e)?this.getAttribute(e):JSON.stringify(this.#config[e]):this.hasAttribute(e)?this.getAttribute(e):this.#config[e],this[e]=t)}set imagelimitation(e){e?(e={...defaults.imagelimitation,...this.imagelimitation,..."string"==typeof e?JSON.parse(e):e},this.setAttribute("imagelimitation",JSON.stringify(e))):this.removeAttribute("imagelimitation")}get imagelimitation(){return this.#config.imagelimitation}set videolimitation(e){e?(e={...defaults.videolimitation,...this.videolimitation,..."string"==typeof e?JSON.parse(e):e},this.setAttribute("videolimitation",JSON.stringify(e))):this.removeAttribute("videolimitation")}get videolimitation(){return this.#config.videolimitation}set accept(e){e?this.setAttribute("accept",e):this.removeAttribute("accept")}get accept(){return this.#config.accept}set webservice(e){e?(e={...defaults.webservice,...this.webservice,..."string"==typeof e?JSON.parse(e):e},this.setAttribute("webservice",JSON.stringify(e))):this.removeAttribute("webservice")}get webservice(){return this.#config.webservice}set multiple(e){this.toggleAttribute("multiple",Boolean(e))}get multiple(){return this.#config.multiple}set maximagecount(e){void 0!==e?this.setAttribute("maximagecount",e):this.removeAttribute("maximagecount")}get maximagecount(){return this.#config.maximagecount}set maxvideocount(e){void 0!==e?this.setAttribute("maxvideocount",e):this.removeAttribute("maxvideocount")}get maxvideocount(){return this.#config.maxvideocount}get processing(){return this.#data.processing}#fireEvent(e,t){this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0,...t&&{detail:t}}))}#getUnitId(){return"unit-"+_wcl.getUUID()}async#fetchFileInfo({type:r,file:t}){return new Promise((a,e)=>{let o;"image"===r?(o=new Image).onload=async()=>{var{naturalWidth:e,naturalHeight:t}=o,i=await this.#getThumbnail({type:r,width:e,height:t,dataURL:o.src});window.URL.revokeObjectURL(o.src),a({type:r,thumbnail:i,width:e,height:t})}:((o=document.createElement("video")).preload="metadata",o.onloadedmetadata=async()=>{var{videoWidth:e,videoHeight:t,duration:i}=o,s=await this.#getThumbnail({type:r,width:e,height:t,dataURL:o.src});window.URL.revokeObjectURL(o.src),a({type:r,thumbnail:s,width:e,height:t,duration:i})}),o.onerror=()=>{window.URL.revokeObjectURL(o.src),e(new Error("fetch file info error."))},o.src=window.URL.createObjectURL(t)})}async#getThumbnail({type:l,width:c,height:d,dataURL:h}){return new Promise((t,e)=>{const i="image"===l?new Image:document.createElement("video"),s=document.createElement("canvas"),a=s.getContext("2d");let o,r,n;s.width=160,s.height=160,n=d<=c?(o=Math.floor((c-d)/2),r=0,d):(o=0,r=Math.floor((d-c)/2),c),i.onerror=()=>{e(new Error("fetch file thumbnail error."))},"image"===l?(i.onload=()=>{a.drawImage(i,o,r,n,n,0,0,160,160),t(s.toDataURL("image/jpeg",.75))},i.src=h):(i.autoplay=!0,i.playsInline=!0,i.preload="auto",i.muted=!0,i.onloadeddata=()=>{var e=/firefox/i.test(navigator.userAgent)?250:100;setTimeout(()=>{a.drawImage(i,o,r,n,n,0,0,160,160),t(s.toDataURL("image/jpeg",.75))},e)},i.style.visibility="hidden",i.style.pointerEvents="none",i.src=h,i.currentTime=1,"function"==typeof i.load&&i.load())})}async#validation(e){let t;var{name:i=""}=e,s=e.type.replace(/(.*)\/.*/,"$1").toLowerCase();try{if(!["image","video"].includes(s))throw new Error("file type not allowed.");var{type:a,thumbnail:o,width:r,height:n,duration:l}=await this.#fetchFileInfo({type:s,file:e}),{minwidth:c,minheight:d,size:h,duration:m}="image"===a?this.imagelimitation:this.videolimitation;if(e.size>h)throw new Error(`file size must under ${h} bytes.`);if(r<c)throw new Error(`file width must be bigger than ${c}px.`);if(n<d)throw new Error(`file height must be bigger than ${c}px.`);if("video"===a&&m<l)throw new Error(`file duration must be smaller than ${m}s.`);t={type:a,file:e,thumbnail:o,name:i,id:this.#getUnitId(),...l&&{duration:l}}}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),this.#fireEvent(custumEvents.error,{message:e.message}),t={type:"error",error:e.message}}return t}async#uploadToS3({id:a,file:e,credential:t}){var{bucketName:t,credentials:i,path:s,region:o}=t,r=_wcl.getUUID();const n=new window.AWS.S3({apiVersion:"2006-03-01",region:o,params:{Bucket:t},credentials:i}),l={Key:s+"/"+r,Body:e};return new Promise((i,s)=>{n.upload(l,(e,t)=>{e?s(e):t&&i(t)}).on("httpUploadProgress",({loaded:e,total:t})=>{let i=Math.floor(e/t*100);95<i&&(i=95),this.#setUnitProgress({id:a,progress:i})})})}#setUnitProgress({id:e,progress:t}){var i=this.#data.units[e];this.#data.units[e]={...i,progress:t},this.#fireEvent(custumEvents.progress,{id:e,progress:t})}async#upload({id:t,type:e,file:i}){var{token:s,upload:a}=this.webservice;try{const{error:c,...d}=await fetch(s.url,{credentials:"include",headers:{"content-type":"application/json"},method:"GET",mode:"cors"}).then(e=>e.json());if(c)throw new Error(c?.message||"Network response was not ok.");var o=(await this.#uploadToS3({id:t,file:i,credential:d}))["Location"],{params:r={},urls:n}=a;const{error:h,...m}=await fetch(n[e],{credentials:"include",headers:{"content-type":"application/json"},method:"POST",mode:"cors",body:JSON.stringify({...r,url:decodeURIComponent(o)})}).then(e=>e.json());if(h)throw new Error(h?.message||"Network response was not ok.");this.#setUnitProgress({id:t,progress:100});var l=this.#data.units[t];this.#data.units[t]={...l,result:m}}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),this.#setUnitProgress({id:t,progress:100});s=this.#data.units[t];this.#data.units[t]={...s,error:e.message},this.#fireEvent(custumEvents.error,{id:t,message:e.message})}this.#detectDone()}#detectDone(){var e;this.#data.order.some(e=>{var{progress:e=0}=this.#data.units[e];return 100!==e})||(e=this.#data.order.map(e=>{var{result:t,error:i,type:s,name:a}=this.#data.units[e];return{id:e,type:s,name:a,...t&&{result:t},...i&&{error:i}}}),this.#setProcessing("end"),this.#fireEvent(custumEvents.done,{results:e}))}passFiles(e){this._onFilesChange({target:{files:e}})}#setProcessing(e){["start","end"].includes(e)&&(this.#data.processing="start"===e,this.#fireEvent(custumEvents["process"+_wcl.capitalize(e)]))}async _onFilesChange(t){var i=this.#nodes["input"],t=t["target"]["files"];if(t&&t.length)if(this.processing)i.value="",this.#fireEvent(custumEvents.error,{message:"file(s) uploading, try later."});else{let e=[];if(isMobile)for(const o of t){var s=await this.#validation(o);e.push(s)}else e=await Promise.all(Array.from(t).map(e=>this.#validation(e)));i.value="";var{image:t=[],video:a=[]}=Object?.groupBy(e,({type:e})=>e)||{},a=[].concat(a.slice(0,this.maxvideocount),t.slice(0,this.maximagecount));if(a.length){const r=[],n=[];a.forEach(e=>{var t={...e};delete t.file,r.push(t),n.push(e.id)}),this.#data.order=n,this.#data.units=r.reduce((e,t)=>{const{id:i,...s}=t;return e[i]={...s,progress:0},e},{}),this.#fireEvent(custumEvents.pick,{picked:r}),this.#setProcessing("start"),a.forEach(e=>{var{id:e,type:t,file:i}=e;this.#upload({id:e,type:t,file:i})})}i.value=""}else i.value=""}}const S=_wcl.supports(),T=_wcl.classToTagName("YahooPixelframeUploader");S.customElements&&S.shadowDOM&&S.template&&!window.customElements.get(T)&&window.customElements.define(_wcl.classToTagName("YahooPixelframeUploader"),YahooPixelframeUploader);export{YahooPixelframeUploader};